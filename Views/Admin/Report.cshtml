@{
    ViewBag.Title = "Report";
    Layout = "~/Views/Admin/Admin_Layout.cshtml";
}

<h3 class="text-dark mb-0" style="padding-top: 20px; display: inline-block;">Complaints</h3>

<!-- Search box and sorting dropdown placed inline with h3 -->
<div class="d-flex justify-content-end mb-3">
    <!-- Search Box -->
    <input type="text" id="searchBox" class="form-control me-2" placeholder="Search..." style="width: 300px;">

    <!-- Open Modal Button -->
    <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#advancedFilterModal">Filter</button>
    <button id="exportBtn" class="btn btn-outline-success">Export Filtered Complaints</button>
    </div>


<!--advancedFilterModal -->
<div class="modal fade" id="advancedFilterModal" tabindex="-1" aria-labelledby="advancedFilterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color:#0B2271">
                <h5 class="modal-title" style="color:white" id="advancedFilterModalLabel">Filter</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success mt-3" role="alert">
                    Note: Only filled fields will be used for filtering.
                </div>
                <!-- Filter Form -->
                <form id="filterForm">
                    <!-- Type of Disability -->
                    <div class="mb-3">
                        <label for="typeOfDisability" class="form-label">Type of Disability</label>
                        <select class="form-select" id="typeOfDisability">
                            <option value="">All Types</option>
                            <option>Deaf</option>
                            <option>Intellectual Disability</option>
                            <option>Learning Disability</option>
                            <option value="Mental">Mental Disability</option>
                            <option value="Physical">Physical Disability (Orthopedic)</option>
                            <option value="Psychosocial">Psychosocial Disability</option>
                            <option value="Speech">Speech and Language Impairment</option>
                            <option value="Visual">Visual Disability</option>
                            <option value="Cancer">Cancer (RA11215)</option>
                            <option value="Rare">Rare Disease (RA10747)</option>
                        </select>
                    </div>

                    <!-- Status -->
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status">
                            <option value="">All Status</option>
                            <option value="Acknowledged">Acknowledged</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>

                    <!-- Establishment -->
                    <div class="mb-3">
                        <label for="establishment" class="form-label">Establishment</label>
                        <input type="text" class="form-control" id="establishment" placeholder="Establishment name">
                    </div>

                    <!-- Branch -->
                    <div class="mb-3">
                        <label for="branch" class="form-label">Branch</label>
                        <input type="text" class="form-control" id="branch" placeholder="Branch name">
                    </div>

                    <!-- Address -->
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <select id="address" class="form-select">
                            <option value="">All Address</option>
                            <option value="I-A">I-A (Sambat)</option>
                            <option value="I-B">I-B (City+Riverside)</option>
                            <option value="I-C">I-C (Bagong Bayan)</option>
                            <option value="II-A">II-A (Triangulo)</option>
                            <option value="II-B">II-B (Guadalupe)</option>
                            <option value="II-C">II-C (Unson)</option>
                            <option value="II-D">II-D (Bulante)</option>
                            <option value="II-E">II-E (San Anton)</option>
                            <option value="II-F">II-F (Villa Rey)</option>
                            <option value="III-A">III-A (Hermanos Belen)</option>
                            <option value="III-B">III-B</option>
                            <option value="III-C">III-C (Labak/De Roma)</option>
                            <option value="III-D">III-D (Villongco)</option>
                            <option value="III-E">III-E</option>
                            <option value="III-F">III-F (Balagtas)</option>
                            <option value="IV-A">IV-A</option>
                            <option value="IV-B">IV-B</option>
                            <option value="IV-C">IV-C</option>
                            <option value="V-A">V-A</option>
                            <option value="V-B">V-B</option>
                            <option value="V-C">V-C</option>
                            <option value="V-D">V-D</option>
                            <option value="VI-A">VI-A (Mavenida)</option>
                            <option value="VI-B">VI-B</option>
                            <option value="VI-C">VI-C (Bagong Pook)</option>
                            <option value="VI-D">VI-D (Lparkers)</option>
                            <option value="VI-E">VI-E (YMCA)</option>
                            <option value="VII-A">VII-A (P. Alcantara)</option>
                            <option value="VII-B">VII-B</option>
                            <option value="VII-C">VII-C</option>
                            <option value="VII-D">VII-D</option>
                            <option value="VII-E">VII-E</option>
                            <option value="Atisan">Atisan</option>
                            <option value="Bautista">Bautista</option>
                            <option value="Concepcion (Bunot)">Concepcion (Bunot)</option>
                            <option value="Del Remedio (Wawa)">Del Remedio (Wawa)</option>
                            <option value="Dolores">Dolores</option>
                            <option value="San Antonio 1 (Balanga)">San Antonio 1 (Balanga)</option>
                            <option value="San Antonio 2 (Sapa)">San Antonio 2 (Sapa)</option>
                            <option value="San Bartolome (Matang-ag)">San Bartolome (Matang-ag)</option>
                            <option value="San Buenaventura (Palakpakin)">San Buenaventura (Palakpakin)</option>
                            <option value="San Crispin (Lumbangan)">San Crispin (Lumbangan)</option>
                            <option value="San Cristobal">San Cristobal</option>
                            <option value="San Diego (Tiim)">San Diego (Tiim)</option>
                            <option value="San Francisco (Calihan)">San Francisco (Calihan)</option>
                            <option value="San Gabriel (Butucan)">San Gabriel (Butucan)</option>
                            <option value="San Gregorio">San Gregorio</option>
                            <option value="San Ignacio">San Ignacio</option>
                            <option value="San Isidro (Balagbag)">San Isidro (Balagbag)</option>
                            <option value="San Joaquin">San Joaquin</option>
                            <option value="San Jose (Malamig)">San Jose (Malamig)</option>
                            <option value="San Juan">San Juan</option>
                            <option value="San Lorenzo (Saluyan)">San Lorenzo (Saluyan)</option>
                            <option value="San Lucas 1 (Malinaw)">San Lucas 1 (Malinaw)</option>
                            <option value="San Lucas 2">San Lucas 2</option>
                            <option value="San Marcos (Tikew)">San Marcos (Tikew)</option>
                            <option value="San Mateo">San Mateo</option>
                            <option value="San Miguel">San Miguel</option>
                            <option value="San Nicolas">San Nicolas</option>
                            <option value="San Pedro">San Pedro</option>
                            <option value="San Rafael (Magampon)">San Rafael (Magampon)</option>
                            <option value="San Roque (Buluburan)">San Roque (Buluburan)</option>
                            <option value="San Vicente">San Vicente</option>
                            <option value="Santa Ana">Santa Ana</option>
                            <option value="Santa Catalina (Sandig)">Santa Catalina (Sandig)</option>
                            <option value="Santa Cruz (Putol)">Santa Cruz (Putol)</option>
                            <option value="Santa Elena">Santa Elena</option>
                            <option value="Santa Filomena (Banlagin)">Santa Filomena (Banlagin)</option>
                            <option value="Santa Isabel">Santa Isabel</option>
                            <option value="Santa Maria">Santa Maria</option>
                            <option value="Santa Maria Magdalena (Boe)">Santa Maria Magdalena (Boe)</option>
                            <option value="Santa Monica">Santa Monica</option>
                            <option value="Santa Veronica (Bae)">Santa Veronica (Bae)</option>
                            <option value="Santiago I (Bulaho)">Santiago I (Bulaho)</option>
                            <option value="Santiago II">Santiago II</option>
                            <option value="Santisimo Rosario">Santisimo Rosario</option>
                            <option value="Santo Angel (Ilog)">Santo Angel (Ilog)</option>
                            <option value="Santo Cristo">Santo Cristo</option>
                            <option value="Santo Niño (Arsum)">Santo Niño (Arsum)</option>
                            <option value="Soledad (Macopa)">Soledad (Macopa)</option>
                        </select>
                    </div>

                    <!-- Apply Filters Button -->
                    <div class="d-flex justify-content-center">
                        <button type="button" class="btn btn-outline-success" id="applyFiltersBtn">Apply Filters</button>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>


<div class="table-responsive">
    <table class="table table-striped" id="tab">
        <thead>
            <tr>
                <th>No.</th>
                <th>Name</th>
                <th>Type of Disability</th>
                <th>Contact No.</th>
                <th>Address</th>
                <th>Email</th>
                <th>Establishment</th>
                <th>Branch</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="reportTableBody">
            @for (int i = 0; i < Model.Count; i++)
            {
                var report = Model[i];
                <tr>
                    <td>@(i + 1)</td>
                    <td>@report.FullName</td>
                    <td>@report.TypeOfDisability</td>
                    <td>@report.MobileNo</td>
                    <td>@report.Barangay</td>
                    <td>@report.EmailAddress</td>
                    <td>@report.Establishment</td>
                    <td>@report.Branch</td>
                    <td>
                        @{
                            if (report.Acknowledged)
                            {
                                <span class="badge bg-success">Acknowledged</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">Pending</span>
                            }
                        }
                    </td>
                    <td>
                        <button class="btn btn-outline-success btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#acknowledgeconfirm" data-report-id="@report.ReportId" data-problem="@report.ProblemDescription"> View Problem </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Acknowledge Confirmation Modal -->
<div class="modal fade" id="acknowledgeconfirm" tabindex="-1" aria-labelledby="acknowledgeconfirm" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color:#0B2271">
                <h5 class="modal-title" style="color:white">Are you sure you want to acknowledge the problem?</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Problem Description in Acknowledgement Modal -->
                <p id="problemDescription"></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn btn-outline-primary" id="acknowledgeButton" data-bs-dismiss="modal">Yes</button>
                <button class="btn btn-outline-danger" type="button" data-bs-dismiss="modal">No</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Bootstrap Bundle JS (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!--SweetAlert-->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

    $(document).ready(function () {
        // Search functionality
        $('#searchBox').on('input', function () {
            var searchText = $(this).val().toLowerCase();
            filterTable(searchText, $('#statusFilter').val());
        });

        // Status filter functionality
        $('#statusFilter').on('change', function () {
            var status = $(this).val();
            filterTable($('#searchBox').val().toLowerCase(), status);
        });

        // Function to filter table
        function filterTable(searchText, status) {
            $('#reportTableBody tr').each(function () {
                var row = $(this);
                var name = row.find('td:nth-child(2)').text().toLowerCase();
                var reportId = row.find('td:nth-child(1)').text().toLowerCase();
                var statusText = row.find('td:nth-child(9) span').text().toLowerCase();

                var matchesSearch = name.includes(searchText) || reportId.includes(searchText);
                var matchesStatus = status ? statusText.includes(status.toLowerCase()) : true;

                if (matchesSearch && matchesStatus) {
                    row.show();
                } else {
                    row.hide();
                }
            });
        }
    });






//Filtering Function :)
    $(document).ready(function () {
        // Open the modal when the "Advanced Filter" button is clicked
        $('#openFilterModalBtn').on('click', function () {
            $('#advancedFilterModal').modal('show');
        });

        // Handle applying filters when the Apply Filters button is clicked
        $('#applyFiltersBtn').on('click', function () {
            var typeOfDisability = $('#typeOfDisability').val();
            var status = $('#status').val();
            var establishment = $('#establishment').val().toLowerCase();
            var branch = $('#branch').val().toLowerCase();
            var address = $('#address').val().toLowerCase();

            

            // // Hide modal after applying filters
            // $('#advancedFilterModal').modal('hide');

            // // Optionally, you can manually remove the backdrop if it's not disappearing
            // $('body').removeClass('modal-open');
            // $('.modal-backdrop').remove();

            // Get the current search term in the search box
            var searchTerm = $('#searchBox').val().toLowerCase();

            // Apply filters to the table
            filterTable(searchTerm, typeOfDisability, status, establishment, branch, address);
        });

        // Function to filter table based on selected criteria
        function filterTable(searchText, typeOfDisability, status, establishment, branch, address) {
            $('#reportTableBody tr').each(function () {
                var row = $(this);
                var name = row.find('td:nth-child(2)').text().toLowerCase();
                var reportId = row.find('td:nth-child(1)').text().toLowerCase();
                var statusText = row.find('td:nth-child(9) span').text().toLowerCase();
                var typeOfDisabilityText = row.find('td:nth-child(3)').text().toLowerCase();
                var establishmentText = row.find('td:nth-child(7)').text().toLowerCase();
                var branchText = row.find('td:nth-child(8)').text().toLowerCase();
                var addressText = row.find('td:nth-child(5)').text().toLowerCase();

                // Check for matches with search term
                var matchesSearch = name.includes(searchText) || reportId.includes(searchText);

                // Apply all filters
                var matchesFilter = true;

                // Filter by Type of Disability
                if (typeOfDisability && !typeOfDisabilityText.includes(typeOfDisability.toLowerCase())) {
                    matchesFilter = false;
                }

                // Filter by Status
                if (status && !statusText.includes(status.toLowerCase())) {
                    matchesFilter = false;
                }

                // Filter by Establishment
                if (establishment && !establishmentText.includes(establishment)) {
                    matchesFilter = false;
                }

                // Filter by Branch
                if (branch && !branchText.includes(branch)) {
                    matchesFilter = false;
                }

                // Filter by Address
                if (address && !addressText.includes(address)) {
                    matchesFilter = false;
                }

                // Show/hide the row based on all conditions
                if (matchesSearch && matchesFilter) {
                    row.show();
                } else {
                    row.hide();
                }
            });
        }
    });

    //EXPORT FILTERED COMPLAINTS OR REPORTS
    $(document).ready(function () {
        $('#exportBtn').on('click', function () {
            var searchTerm = $('#searchBox').val();
            var typeOfDisability = $('#typeOfDisability').val();
            var status = $('#status').val();
            var establishment = $('#establishment').val();
            var branch = $('#branch').val();
            var address = $('#address').val();

            // Construct query string
            var query = $.param({
                searchTerm: searchTerm,
                typeOfDisability: typeOfDisability,
                status: status,
                establishment: establishment,
                branch: branch,
                address: address
            });

            // Redirect to the export URL with filters
            window.location.href = '/Admin/ExportReport?' + query;
        });
    });



    // JavaScript to pass ProblemDescription to the modal
    $('#acknowledgeconfirm').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Button that triggered the modal
        var problemDescription = button.data('problem'); // Extract the ProblemDescription from data-* attribute
        var modal = $(this);
        modal.find('.modal-body #problemDescription').text(problemDescription); // Set the text of the modal body
        var reportId = button.data('report-id'); // Extract report ID from data-* attribute
        $('#acknowledgeButton').data('report-id', reportId); // Set the report ID on the Yes button
    });

    // Handle the acknowledge button click
    $('#acknowledgeButton').on('click', function () {
        var reportId = $(this).data('report-id'); // Get the report ID

        // Make an AJAX POST request to send the acknowledgment
        $.ajax({
            url: '/Admin/AcknowledgeReport',
            type: 'POST',
            data: { id: reportId },
            success: function (response) {
                if (response.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Acknowledged!',
                        text: response.message,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        // Update the status column dynamically
                        $('button[data-report-id="' + reportId + '"]').closest('tr').find('td:nth-child(9)').html('<span class="badge bg-success">Acknowledged</span>');
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: response.message,
                        confirmButtonText: 'OK'
                    });
                }
            },
            error: function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while processing the acknowledgment.',
                    confirmButtonText: 'OK'
                });
            }
        });
    });

    //acknowledge
    $('#acknowledgeconfirm').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget); // Button that triggered the modal
        var problemDescription = button.data('problem'); // Extract the ProblemDescription from data-* attribute
        var modal = $(this);
        var reportId = button.data('report-id'); // Extract report ID from data-* attribute

        // Set the problem description text
        modal.find('.modal-body #problemDescription').text(problemDescription);

        // Check if the report is already acknowledged
        var isAcknowledged = button.closest('tr').find('td:nth-child(9) span').hasClass('bg-success');
        var acknowledgeButton = modal.find('#acknowledgeButton');
        var noButton = modal.find('.btn-outline-danger'); // Select the "No" button

        if (isAcknowledged) {
            // Disable both the "Yes" and "No" buttons if already acknowledged
            acknowledgeButton.prop('disabled', true);
            noButton.prop('disabled', true);
        } else {
            // Enable both the "Yes" and "No" buttons if not acknowledged
            acknowledgeButton.prop('disabled', false);
            noButton.prop('disabled', false);
        }

        // Attach the report ID to the "Yes" button
        acknowledgeButton.data('report-id', reportId);
    });

</script>

